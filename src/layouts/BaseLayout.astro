---
import '../styles/global.css';
import { getI18n, type Lang } from '../i18n';
import NavBar from '../components/vue/NavBar.vue';
import BackToTop from '../components/vue/BackToTop.vue';

interface Props {
  title: string;
  description?: string;
  lang: Lang;
}

const { title, description, lang } = Astro.props;
const { t } = getI18n(lang);

const htmlLang = lang === 'zh' ? 'zh-CN' : lang === 'en' ? 'en-US' : 'ja-JP';

const descriptions: Record<Lang, string> = {
  zh: 'RushDB 实验室 - 专注于数据库系统研究与开发的技术团队，致力于推动数据库技术的创新与发展。',
  en: 'RushDB Lab - A technology team focused on database system research and development, dedicated to promoting innovation and development of database technology.',
  ja: 'RushDB Lab - データベースシステムの研究開発に特化した技術チームで、データベース技術の革新と発展を推進しています。',
};

const metaDescription = description || descriptions[lang];
---

<!doctype html>
<html lang={htmlLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={metaDescription} />
    <meta name="keywords" content="RushDB, 数据库, Database, 技术实验室, 开源项目, MiniOB" />
    <meta name="author" content="RushDB Lab" />
    <link rel="canonical" href={`https://rushdb-lab.github.io/${lang}/`} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={`https://rushdb-lab.github.io/${lang}/`} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content="https://rushdb-lab.github.io/RushDB.png" />
    <meta property="og:locale" content={htmlLang.replace('-', '_')} />
    <meta property="og:site_name" content="RushDB Lab" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={`https://rushdb-lab.github.io/${lang}/`} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content="https://rushdb-lab.github.io/RushDB.png" />

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link rel="icon" type="image/png" href="/RushDB.png" />
    <link rel="shortcut icon" type="image/png" href="/RushDB.png" />
    <link rel="apple-touch-icon" href="/RushDB.png" />
    <meta name="theme-color" content="#050712" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#fdf6e3" media="(prefers-color-scheme: light)" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap"
      rel="stylesheet"
    />

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "RushDB Lab",
      "alternateName": "RushDB 实验室",
      "url": "https://rushdb-lab.github.io/",
      "logo": "https://rushdb-lab.github.io/RushDB.png",
      "description": metaDescription,
      "sameAs": ["https://github.com/RushDB-Lab"],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "technical support",
        "availableLanguage": ["Chinese", "English", "Japanese"]
      }
    })} />

    <!-- Alternate language links -->
    <link rel="alternate" hreflang="zh" href="https://rushdb-lab.github.io/zh/" />
    <link rel="alternate" hreflang="en" href="https://rushdb-lab.github.io/en/" />
    <link rel="alternate" hreflang="ja" href="https://rushdb-lab.github.io/ja/" />
    <link rel="alternate" hreflang="x-default" href="https://rushdb-lab.github.io/zh/" />

    <!-- Theme initialization (FOUC prevention - must run before first paint) -->
    <script is:inline>
      (function() {
        var KEY = 'rushdb-theme';
        var ALLOWED = { dark: 1, light: 1 };
        var root = document.documentElement;

        function sanitize(v) { return typeof v === 'string' && ALLOWED[v] ? v : null; }
        function readStorage() { try { return sanitize(localStorage.getItem(KEY)); } catch(e) { return null; } }

        var media = window.matchMedia('(prefers-color-scheme: dark)');
        var systemTheme = media.matches ? 'dark' : 'light';
        var stored = readStorage();
        var resolved = stored || systemTheme;

        root.setAttribute('data-theme', resolved);
        root.style.colorScheme = resolved;
        root.setAttribute('data-theme-source', stored ? 'user' : 'system');
        root.classList.add('theme-preload');

        window.__rushdbTheme = {
          get: function() { return root.getAttribute('data-theme') || 'dark'; },
          set: function(next, persist) {
            var safe = sanitize(next);
            if (!safe) return;
            root.setAttribute('data-theme', safe);
            root.style.colorScheme = safe;
            root.setAttribute('data-theme-source', persist !== false ? 'user' : 'system');
            try {
              if (persist !== false) localStorage.setItem(KEY, safe);
              else localStorage.removeItem(KEY);
            } catch(e) {}
            window.dispatchEvent(new CustomEvent('rushdb-theme-change', { detail: { theme: safe } }));
          },
          toggle: function() {
            var current = root.getAttribute('data-theme') || 'dark';
            this.set(current === 'dark' ? 'light' : 'dark', true);
          }
        };

        var onMediaChange = function(e) {
          if (root.getAttribute('data-theme-source') === 'user') return;
          var t = e.matches ? 'dark' : 'light';
          root.setAttribute('data-theme', t);
          root.style.colorScheme = t;
          window.dispatchEvent(new CustomEvent('rushdb-theme-change', { detail: { theme: t } }));
        };
        if (media.addEventListener) {
          media.addEventListener('change', onMediaChange);
        } else if (media.addListener) {
          media.addListener(onMediaChange);
        }
      })();
    </script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">{t('a11y.skipToContent')}</a>
    <div class="scroll-progress" id="scroll-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label={t('a11y.scrollProgress')}></div>

    <NavBar client:idle lang={lang} currentPath={Astro.url.pathname} />

    <slot />

    <BackToTop client:idle lang={lang} />

    <script is:inline>
      document.documentElement.classList.add('js');
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const supportsFinePointer = window.matchMedia('(hover: hover) and (pointer: fine)').matches;

      // Scroll progress
      function updateScrollProgress() {
        const scrollProgress = document.getElementById('scroll-progress');
        if (!scrollProgress) return;

        const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
        const progress = maxScroll > 0 ? window.scrollY / maxScroll : 0;
        scrollProgress.style.transform = `scaleX(${progress})`;
        scrollProgress.setAttribute('aria-valuenow', String(Math.round(progress * 100)));
      }

      // Mouse follow effect (skip on touch and reduced motion)
      function setupMousePositionEffect() {
        if (prefersReducedMotion || !supportsFinePointer) return;

        let pointerRaf = null;
        window.addEventListener('pointermove', (event) => {
          if (event.pointerType === 'touch' || pointerRaf !== null) return;
          pointerRaf = requestAnimationFrame(() => {
            document.body.style.setProperty('--mx', `${event.clientX}px`);
            document.body.style.setProperty('--my', `${event.clientY}px`);
            pointerRaf = null;
          });
        }, { passive: true });
      }

      // Section visibility observer
      function setupSectionObserver() {
        const sections = Array.from(document.querySelectorAll('.section'));
        if (sections.length === 0) return;

        let remaining = sections.length;
        const observer = new IntersectionObserver((entries) => {
          for (const entry of entries) {
            if (!entry.isIntersecting) continue;
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
            observer.unobserve(entry.target);
            remaining -= 1;
          }

          if (remaining <= 0) observer.disconnect();
        }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

        sections.forEach((el) => observer.observe(el));
      }

      // Busuanzi analytics
      function loadBusuanziScript() {
        if (document.getElementById('busuanzi-script')) return;
        const script = document.createElement('script');
        script.id = 'busuanzi-script';
        script.async = true;
        script.src = 'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
        document.body.appendChild(script);
      }

      function setupBusuanziLoader() {
        let loaded = false;
        const loadOnce = () => {
          if (loaded) return;
          loaded = true;
          loadBusuanziScript();
        };

        const footer = document.querySelector('.footer');
        if (!footer) {
          loadOnce();
          return;
        }

        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries) => {
            if (entries.some((entry) => entry.isIntersecting)) {
              observer.disconnect();
              loadOnce();
            }
          }, { rootMargin: '240px 0px 240px 0px' });
          observer.observe(footer);
        } else {
          loadOnce();
        }

        // Fallback to avoid missing stats on pages where footer is never reached.
        if ('requestIdleCallback' in window) {
          window.requestIdleCallback(loadOnce, { timeout: 5000 });
        } else {
          setTimeout(loadOnce, 5000);
        }
      }

      // Scroll to section requested from another page (keeps URL clean)
      function handlePendingSectionScroll() {
        const key = 'rushdb-scroll-target';
        const targetId = sessionStorage.getItem(key);
        if (!targetId) return;

        const targetEl = document.getElementById(targetId);
        if (!targetEl) {
          sessionStorage.removeItem(key);
          return;
        }

        requestAnimationFrame(() => {
          targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          sessionStorage.removeItem(key);
        });
      }

      // Initialize
      let scrollRaf = null;

      window.addEventListener('scroll', () => {
        if (scrollRaf !== null) return;
        scrollRaf = requestAnimationFrame(() => {
          updateScrollProgress();
          scrollRaf = null;
        });
      }, { passive: true });

      document.addEventListener('DOMContentLoaded', () => {
        requestAnimationFrame(() => document.documentElement.classList.remove('theme-preload'));
        updateScrollProgress();
        setupMousePositionEffect();
        setupSectionObserver();
        setupBusuanziLoader();
        handlePendingSectionScroll();
      });
    </script>
  </body>
</html>
