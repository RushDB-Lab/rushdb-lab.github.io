---
import { Image } from 'astro:assets';
import { getI18n, type Lang } from '../../i18n';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const { t } = getI18n(lang);

const fullTitle = t('hero.title');
const brand = 'RushDB';
const rawMotto = fullTitle.startsWith(brand) ? fullTitle.slice(brand.length) : fullTitle;
const mottoText = rawMotto.replace(/^[\s,、，]+/, '');
const panelWidthByLang: Record<Lang, string> = {
  zh: '620px',
  en: '580px',
  ja: '630px',
};
const heroStyle = `--hero-panel-width: ${panelWidthByLang[lang]};`;
---

<section class="hero" style={heroStyle}>
  <div class="container">
    <div class="hero-grid">
      <div class="hero-content">
        <div class="logo-container" aria-hidden="true">
          <div class="logo">
            <Image src="/RushDB.png" alt="RushDB Logo" width={697} height={697} priority />
          </div>
        </div>
        <h1 class="hero-title" data-brand={brand} data-motto={mottoText}>
          <span class="hero-placeholder" aria-hidden="true">{brand}<br />{mottoText}</span>
          <span class="hero-typed">
            <span class="hero-line"><span class="hero-brand"></span></span>
            <span class="hero-line"><span class="hero-motto"></span></span>
          </span>
        </h1>
        <p class="hero-subtitle">
          {t('hero.subtitle')}
        </p>
        <div class="hero-actions">
          <a href="#about" class="cta-button">
            <span>{t('hero.actions.learnMore')}</span>
            <span>→</span>
          </a>
          <a href="https://github.com/RushDB-Lab" class="secondary-button" target="_blank" rel="noopener noreferrer">
            <span class="inline">{t('hero.actions.openGithub')}</span>
            <span aria-hidden="true">↗</span>
          </a>
          <a href="#projects" class="secondary-button">
            <span class="inline">{t('hero.actions.viewProjects')}</span>
            <span aria-hidden="true">→</span>
          </a>
        </div>
      </div>
      <div class="hero-panel" aria-hidden="true">
        <div class="panel">
          <div class="panel-inner">
            <div class="panel-kicker">
              <span class="panel-kicker-badge"></span>
              <span>{t('hero.panel.kicker')}</span>
            </div>
            <div class="panel-title">
              {t('hero.panel.title')}
            </div>
            <div class="panel-body">
              {t('hero.panel.body')}
            </div>
            <div class="panel-metrics">
              <div class="metric">
                <div class="metric-number">3</div>
                <div class="metric-label">{t('hero.panel.metrics.members')}</div>
              </div>
              <div class="metric">
                <div class="metric-number">4</div>
                <div class="metric-label">{t('hero.panel.metrics.awards')}</div>
              </div>
              <div class="metric">
                <div class="metric-number">1</div>
                <div class="metric-label">{t('hero.panel.metrics.openSource')}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function initTypewriter() {
    const title = document.querySelector<HTMLElement>('.hero-title');
    if (!title) return;

    const placeholder = title.querySelector<HTMLElement>('.hero-placeholder');
    const brandEl = title.querySelector<HTMLElement>('.hero-brand');
    const mottoEl = title.querySelector<HTMLElement>('.hero-motto');
    if (!brandEl || !mottoEl) return;

    const brand = title.dataset.brand ?? '';
    const motto = title.dataset.motto ?? '';

    // Respect prefers-reduced-motion: show full text immediately
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      brandEl.textContent = brand;
      mottoEl.textContent = motto;
      if (placeholder) placeholder.style.display = 'none';
      revealFollowUp();
      return;
    }

    let i = 0;
    let phase: 'brand' | 'motto' = 'brand';
    brandEl.classList.add('typing');

    function type() {
      if (phase === 'brand') {
        if (i < brand.length) {
          brandEl!.textContent += brand[i];
          i++;
          setTimeout(type, 80);
        } else {
          brandEl!.classList.remove('typing');
          mottoEl!.classList.add('typing');
          phase = 'motto';
          i = 0;
          setTimeout(type, 100);
        }
      } else {
        if (i < motto.length) {
          mottoEl!.textContent += motto[i];
          i++;
          setTimeout(type, 100);
        } else {
          // Typing done — blink cursor then fade out
          mottoEl!.classList.remove('typing');
          mottoEl!.classList.add('typing-done');
          setTimeout(() => mottoEl!.classList.remove('typing-done'), 1500);
          revealFollowUp();
        }
      }
    }

    // Start typing after a brief delay
    setTimeout(type, 400);
  }

  function revealFollowUp() {
    const subtitle = document.querySelector<HTMLElement>('.hero-subtitle');
    const actions = document.querySelector<HTMLElement>('.hero-actions');
    if (subtitle) subtitle.classList.add('hero-revealed');
    if (actions) {
      setTimeout(() => actions.classList.add('hero-revealed'), 150);
    }
  }

  // Run on initial load and on Astro page transitions
  initTypewriter();
  document.addEventListener('astro:after-swap', initTypewriter);
</script>
