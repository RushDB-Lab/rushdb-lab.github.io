---
import { getCollection, type CollectionEntry } from 'astro:content';
import { getI18n, type Lang } from '../../i18n';

const relatedPostsCache = new Map<Lang, Promise<CollectionEntry<'blog'>[]>>();

function getPostsByLang(lang: Lang) {
  let cachedPosts = relatedPostsCache.get(lang);
  if (!cachedPosts) {
    cachedPosts = getCollection('blog', ({ id }) => id.startsWith(`${lang}/`));
    relatedPostsCache.set(lang, cachedPosts);
  }
  return cachedPosts;
}

interface Props {
  currentPost: CollectionEntry<'blog'>;
  lang: Lang;
  maxPosts?: number;
}

const { currentPost, lang, maxPosts = 3 } = Astro.props;
const { t } = getI18n(lang);

// Get all posts in the same language
const allPosts = await getPostsByLang(lang);
const currentPostTimestamp = currentPost.data.pubDate.getTime();
const currentTags = new Set(currentPost.data.tags);

// Calculate relevance score for each post
function getRelevanceScore(post: CollectionEntry<'blog'>): number {
  if (post.id === currentPost.id) return -1; // Exclude current post

  let score = 0;

  // Same category: +3 points
  if (post.data.category === currentPost.data.category) {
    score += 3;
  }

  // Matching tags: +1 point per match
  for (const tag of post.data.tags) {
    if (currentTags.has(tag)) {
      score += 1;
    }
  }

  // Recency bonus: more recent posts get slight preference
  const daysDiff = Math.abs(
    (post.data.pubDate.getTime() - currentPostTimestamp) / (1000 * 60 * 60 * 24)
  );
  if (daysDiff < 30) score += 0.5;
  if (daysDiff < 7) score += 0.5;

  return score;
}

// Sort by relevance and take top N
const relatedPosts = allPosts
  .map(post => ({ post, score: getRelevanceScore(post) }))
  .filter(({ score }) => score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, maxPosts)
  .map(({ post }) => post);

// Helper to get slug
function getSlug(post: CollectionEntry<'blog'>): string {
  const [, ...slugParts] = post.id.split('/');
  return slugParts.join('/').replace(/\.md$/, '');
}

// Format date
function formatDate(date: Date): string {
  return date.toLocaleDateString(
    lang === 'zh' ? 'zh-CN' : lang === 'ja' ? 'ja-JP' : 'en-US',
    { year: 'numeric', month: 'short', day: 'numeric' }
  );
}
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <h2 class="related-posts-title">
      <span class="related-posts-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
      </span>
      {t('blog.relatedPosts')}
    </h2>

    <div class="related-posts-grid">
      {relatedPosts.map((post) => (
        <a href={`/${lang}/blog/${getSlug(post)}/`} class="related-post-card">
          <div class="related-post-meta">
            <span class="related-post-category">{t(`blog.categories.${post.data.category}`)}</span>
            <span class="related-post-date">{formatDate(post.data.pubDate)}</span>
          </div>
          <h3 class="related-post-title">{post.data.title}</h3>
          <p class="related-post-description">{post.data.description}</p>
          <span class="related-post-link">
            {t('blog.readMore')}
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </span>
        </a>
      ))}
    </div>
  </section>
)}

<style>
  .related-posts {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid var(--line);
  }

  .related-posts-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 1.5rem;
  }

  .related-posts-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(168, 85, 247, 0.15));
    border-radius: 10px;
    color: var(--c1);
  }

  .related-posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.25rem;
  }

  .related-post-card {
    display: flex;
    flex-direction: column;
    padding: 1.25rem;
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 14px;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    overflow: hidden;
  }

  .related-post-card::before {
    content: "";
    position: absolute;
    inset: -1px;
    background: linear-gradient(
      135deg,
      rgba(34, 211, 238, 0.3),
      rgba(168, 85, 247, 0.2),
      rgba(96, 165, 250, 0.2)
    );
    border-radius: inherit;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .related-post-card:hover {
    transform: translateY(-4px);
    border-color: rgba(34, 211, 238, 0.25);
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.15),
      0 12px 28px rgba(34, 211, 238, 0.08);
  }

  .related-post-card:hover::before {
    opacity: 1;
  }

  .related-post-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
  }

  .related-post-category {
    color: var(--c1);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .related-post-date {
    color: var(--text-3);
  }

  .related-post-title {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
    margin-bottom: 0.5rem;
    transition: color 0.3s ease;
  }

  .related-post-card:hover .related-post-title {
    color: var(--c1);
  }

  .related-post-description {
    color: var(--text-2);
    font-size: 0.85rem;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
    margin-bottom: 0.75rem;
  }

  .related-post-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--c2);
    font-size: 0.85rem;
    font-weight: 600;
  }

  .related-post-link svg {
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .related-post-card:hover .related-post-link svg {
    transform: translateX(4px);
  }

  @media (max-width: 640px) {
    .related-posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
